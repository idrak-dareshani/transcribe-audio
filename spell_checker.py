from difflib import SequenceMatcher
import json
import os

class UrduSpellChecker:
    def __init__(self):
        # Common Urdu words dictionary (you can expand this)
        self.urdu_dictionary = {
            # Religious terms
            'اللہ', 'تعالیٰ', 'قرآن', 'حدیث', 'نماز', 'روزہ', 'زکوۃ', 'حج', 'جنت', 'جہنم',
            'مسلمان', 'اسلام', 'ایمان', 'کافر', 'مومن', 'توبہ', 'استغفار', 'دعا', 'ذکر',
            'صلی', 'علیہ', 'وسلم', 'رضی', 'عنہ', 'عنہا', 'السلام', 'سبحان', 'الحمد',
            'للہ', 'اکبر', 'انشاء', 'آمین', 'بسم', 'الرحمن', 'الرحیم', 'ماشاء',
            
            # Common words
            'یہ', 'وہ', 'کیا', 'کیوں', 'کہاں', 'کب', 'کون', 'کس', 'کتنا', 'کتنی',
            'کیسے', 'کیسا', 'کیسی', 'اور', 'یا', 'لیکن', 'مگر', 'پھر', 'تو', 'سے',
            'میں', 'پر', 'کے', 'کی', 'کا', 'کو', 'نے', 'ہے', 'ہیں', 'تھا', 'تھی',
            'تھے', 'گا', 'گی', 'گے', 'ہوا', 'ہوی', 'ہوئے', 'کیا', 'کی', 'کیے',
            'دیا', 'دی', 'دیے', 'لیا', 'لی', 'لیے', 'آیا', 'آئی', 'آئے', 'گیا',
            'گئی', 'گئے', 'چاہیے', 'سکتا', 'سکتی', 'سکتے', 'پڑتا', 'پڑتی', 'پڑتے',
            'ہونا', 'کرنا', 'دینا', 'لینا', 'آنا', 'جانا', 'پڑنا', 'رکھنا', 'دیکھنا',
            'سننا', 'کہنا', 'بولنا', 'لکھنا', 'پڑھنا', 'سیکھنا', 'سکھانا', 'سمجھنا',
            'سمجھانا', 'بتانا', 'پتا', 'معلوم', 'خبر', 'بات', 'کام', 'وقت', 'دن',
            'رات', 'صبح', 'شام', 'دوپہر', 'آج', 'کل', 'پرسوں', 'اب', 'پہلے', 'بعد',
            'اوپر', 'نیچے', 'آگے', 'پیچھے', 'دائیں', 'بائیں', 'اندر', 'باہر', 'یہاں',
            'وہاں', 'کہیں', 'سب', 'کچھ', 'کوئی', 'کسی', 'ہر', 'ہم', 'آپ', 'میں',
            'تم', 'تو', 'وہ', 'یہ', 'اس', 'ان', 'جو', 'جس', 'جن', 'کہ', 'اگر',
            'اگرچہ', 'حالانکہ', 'بالفرض', 'جب', 'جہاں', 'جدھر', 'جتنا', 'جتنی',
            'جیسا', 'جیسی', 'جیسے', 'مثل', 'طرح', 'طور', 'ویسا', 'ویسی', 'ویسے',
            'ایسا', 'ایسی', 'ایسے', 'اتنا', 'اتنی', 'اتنے', 'بہت', 'زیادہ', 'کم',
            'تھوڑا', 'تھوڑی', 'تھوڑے', 'پورا', 'پوری', 'پورے', 'آدھا', 'آدھی', 'آدھے',
            'اچھا', 'اچھی', 'اچھے', 'برا', 'بری', 'برے', 'بڑا', 'بڑی', 'بڑے',
            'چھوٹا', 'چھوٹی', 'چھوٹے', 'لمبا', 'لمبی', 'لمبے', 'چوڑا', 'چوڑی', 'چوڑے',
            'گہرا', 'گہری', 'گہرے', 'اونچا', 'اونچی', 'اونچے', 'نیچا', 'نیچی', 'نیچے',
            'تیز', 'آہستہ', 'جلدی', 'دیر', 'نیا', 'نئی', 'نئے', 'پرانا', 'پرانی', 'پرانے',
            'صاف', 'گندا', 'گندی', 'گندے', 'سفید', 'کالا', 'کالی', 'کالے', 'لال',
            'ہرا', 'ہری', 'ہرے', 'نیلا', 'نیلی', 'نیلے', 'پیلا', 'پیلی', 'پیلے',
            'گلابی', 'بھورا', 'بھوری', 'بھورے', 'سنہری', 'چاندی', 'سونا', 'چاندی',
            'پانی', 'آگ', 'ہوا', 'زمین', 'آسمان', 'سورج', 'چاند', 'ستارہ', 'ستارے',
            'بادل', 'بارش', 'برف', 'موسم', 'گرمی', 'سردی', 'خوشی', 'غم', 'خوف',
            'امید', 'محبت', 'نفرت', 'غصہ', 'حیرت', 'فکر', 'پریشانی', 'آرام', 'راحت',
            'تکلیف', 'درد', 'بیماری', 'صحت', 'طاقت', 'کمزوری', 'زندگی', 'موت',
            'پیدائش', 'مرنا', 'جینا', 'رونا', 'ہنسنا', 'کھیلنا', 'کھانا', 'پینا',
            'سونا', 'بیٹھنا', 'کھڑا', 'چلنا', 'دوڑنا', 'اڑنا', 'گرنا', 'اٹھنا'
        }
        
        # Common misspellings and their corrections
        self.common_corrections = {
            'اللة': 'اللہ',
            'الله': 'اللہ',
            'تعالا': 'تعالیٰ',
            'قران': 'قرآن',
            'نماض': 'نماز',
            'روضہ': 'روزہ',
            'زکات': 'زکوۃ',
            'حج': 'حج',
            'جنة': 'جنت',
            'جہنم': 'جہنم',
            'مسلمان': 'مسلمان',
            'اسلام': 'اسلام',
            'ایمان': 'ایمان',
            'کافر': 'کافر',
            'مومن': 'مومن',
            'توبة': 'توبہ',
            'استغفار': 'استغفار',
            'دعا': 'دعا',
            'ذکر': 'ذکر',
            'صلي': 'صلی',
            'علیة': 'علیہ',
            'وسلم': 'وسلم',
            'رضي': 'رضی',
            'عنة': 'عنہ',
            'عنہا': 'عنہا',
            'السلام': 'السلام',
            'سبحان': 'سبحان',
            'الحمد': 'الحمد',
            'للة': 'للہ',
            'اکبر': 'اکبر',
            'انشا': 'انشاء',
            'آمین': 'آمین',
            'بسم': 'بسم',
            'الرحمن': 'الرحمن',
            'الرحیم': 'الرحیم',
            'ماشا': 'ماشاء',
            'یے': 'یہ',
            'وے': 'وہ',
            'کیا': 'کیا',
            'کیوں': 'کیوں',
            'کہاں': 'کہاں',
            'کب': 'کب',
            'کون': 'کون',
            'کس': 'کس',
            'کتنا': 'کتنا',
            'کتنی': 'کتنی',
            'کیسے': 'کیسے',
            'کیسا': 'کیسا',
            'کیسی': 'کیسی',
            'اور': 'اور',
            'یا': 'یا',
            'لیکن': 'لیکن',
            'مگر': 'مگر',
            'پھر': 'پھر',
            'تو': 'تو',
            'سے': 'سے',
            'میں': 'میں',
            'پر': 'پر',
            'کے': 'کے',
            'کی': 'کی',
            'کا': 'کا',
            'کو': 'کو',
            'نے': 'نے',
            'ہے': 'ہے',
            'ہیں': 'ہیں',
            'تھا': 'تھا',
            'تھی': 'تھی',
            'تھے': 'تھے',
            'گا': 'گا',
            'گی': 'گی',
            'گے': 'گے',
            'ہوا': 'ہوا',
            'ہوی': 'ہوی',
            'ہوئے': 'ہوئے',
            'کیا': 'کیا',
            'کی': 'کی',
            'کیے': 'کیے',
            'دیا': 'دیا',
            'دی': 'دی',
            'دیے': 'دیے',
            'لیا': 'لیا',
            'لی': 'لی',
            'لیے': 'لیے',
            'آیا': 'آیا',
            'آئی': 'آئی',
            'آئے': 'آئے',
            'گیا': 'گیا',
            'گئی': 'گئی',
            'گئے': 'گئے',
            'چاہیے': 'چاہیے',
            'سکتا': 'سکتا',
            'سکتی': 'سکتی',
            'سکتے': 'سکتے',
            'پڑتا': 'پڑتا',
            'پڑتی': 'پڑتی',
            'پڑتے': 'پڑتے',
            'ہونا': 'ہونا',
            'کرنا': 'کرنا',
            'دینا': 'دینا',
            'لینا': 'لینا',
            'آنا': 'آنا',
            'جانا': 'جانا',
            'پڑنا': 'پڑنا',
            'رکھنا': 'رکھنا',
            'دیکھنا': 'دیکھنا',
            'سننا': 'سننا',
            'کہنا': 'کہنا',
            'بولنا': 'بولنا',
            'لکھنا': 'لکھنا',
            'پڑھنا': 'پڑھنا',
            'سیکھنا': 'سیکھنا',
            'سکھانا': 'سکھانا',
            'سمجھنا': 'سمجھنا',
            'سمجھانا': 'سمجھانا',
            'بتانا': 'بتانا',
            'پتا': 'پتا',
            'معلوم': 'معلوم',
            'خبر': 'خبر',
            'بات': 'بات',
            'کام': 'کام',
            'وقت': 'وقت',
            'دن': 'دن',
            'رات': 'رات',
            'صبح': 'صبح',
            'شام': 'شام',
            'دوپہر': 'دوپہر',
            'آج': 'آج',
            'کل': 'کل',
            'پرسوں': 'پرسوں',
            'اب': 'اب',
            'پہلے': 'پہلے',
            'بعد': 'بعد',
            'اوپر': 'اوپر',
            'نیچے': 'نیچے',
            'آگے': 'آگے',
            'پیچھے': 'پیچھے',
            'دائیں': 'دائیں',
            'بائیں': 'بائیں',
            'اندر': 'اندر',
            'باہر': 'باہر',
            'یہاں': 'یہاں',
            'وہاں': 'وہاں',
            'کہیں': 'کہیں',
            'سب': 'سب',
            'کچھ': 'کچھ',
            'کوئی': 'کوئی',
            'کسی': 'کسی',
            'ہر': 'ہر',
            'ہم': 'ہم',
            'آپ': 'آپ',
            'میں': 'میں',
            'تم': 'تم',
            'تو': 'تو',
            'وہ': 'وہ',
            'یہ': 'یہ',
            'اس': 'اس',
            'ان': 'ان',
            'جو': 'جو',
            'جس': 'جس',
            'جن': 'جن',
            'کہ': 'کہ',
            'اگر': 'اگر',
            'اگرچہ': 'اگرچہ',
            'حالانکہ': 'حالانکہ',
            'بالفرض': 'بالفرض',
            'جب': 'جب',
            'جہاں': 'جہاں',
            'جدھر': 'جدھر',
            'جتنا': 'جتنا',
            'جتنی': 'جتنی',
            'جیسا': 'جیسا',
            'جیسی': 'جیسی',
            'جیسے': 'جیسے',
            'مثل': 'مثل',
            'طرح': 'طرح',
            'طور': 'طور',
            'ویسا': 'ویسا',
            'ویسی': 'ویسی',
            'ویسے': 'ویسے',
            'ایسا': 'ایسا',
            'ایسی': 'ایسی',
            'ایسے': 'ایسے',
            'اتنا': 'اتنا',
            'اتنی': 'اتنی',
            'اتنے': 'اتنے',
            'بہت': 'بہت',
            'زیادہ': 'زیادہ',
            'کم': 'کم',
            'تھوڑا': 'تھوڑا',
            'تھوڑی': 'تھوڑی',
            'تھوڑے': 'تھوڑے',
            'پورا': 'پورا',
            'پوری': 'پوری',
            'پورے': 'پورے',
            'آدھا': 'آدھا',
            'آدھی': 'آدھی',
            'آدھے': 'آدھے',
            'اچھا': 'اچھا',
            'اچھی': 'اچھی',
            'اچھے': 'اچھے',
            'برا': 'برا',
            'بری': 'بری',
            'برے': 'برے',
            'بڑا': 'بڑا',
            'بڑی': 'بڑی',
            'بڑے': 'بڑے',
            'چھوٹا': 'چھوٹا',
            'چھوٹی': 'چھوٹی',
            'چھوٹے': 'چھوٹے',
            'لمبا': 'لمبا',
            'لمبی': 'لمبی',
            'لمبے': 'لمبے',
            'چوڑا': 'چوڑا',
            'چوڑی': 'چوڑی',
            'چوڑے': 'چوڑے',
            'گہرا': 'گہرا',
            'گہری': 'گہری',
            'گہرے': 'گہرے',
            'اونچا': 'اونچا',
            'اونچی': 'اونچی',
            'اونچے': 'اونچے',
            'نیچا': 'نیچا',
            'نیچی': 'نیچی',
            'نیچے': 'نیچے',
            'تیز': 'تیز',
            'آہستہ': 'آہستہ',
            'جلدی': 'جلدی',
            'دیر': 'دیر',
            'نیا': 'نیا',
            'نئی': 'نئی',
            'نئے': 'نئے',
            'پرانا': 'پرانا',
            'پرانی': 'پرانی',
            'پرانے': 'پرانے',
            'صاف': 'صاف',
            'گندا': 'گندا',
            'گندی': 'گندی',
            'گندے': 'گندے',
            'سفید': 'سفید',
            'کالا': 'کالا',
            'کالی': 'کالی',
            'کالے': 'کالے',
            'لال': 'لال',
            'ہرا': 'ہرا',
            'ہری': 'ہری',
            'ہرے': 'ہرے',
            'نیلا': 'نیلا',
            'نیلی': 'نیلی',
            'نیلے': 'نیلے',
            'پیلا': 'پیلا',
            'پیلی': 'پیلی',
            'پیلے': 'پیلے',
            'گلابی': 'گلابی',
            'بھورا': 'بھورا',
            'بھوری': 'بھوری',
            'بھورے': 'بھورے',
            'سنہری': 'سنہری',
            'چاندی': 'چاندی',
            'سونا': 'سونا',
            'چاندی': 'چاندی',
            'پانی': 'پانی',
            'آگ': 'آگ',
            'ہوا': 'ہوا',
            'زمین': 'زمین',
            'آسمان': 'آسمان',
            'سورج': 'سورج',
            'چاند': 'چاند',
            'ستارہ': 'ستارہ',
            'ستارے': 'ستارے',
            'بادل': 'بادل',
            'بارش': 'بارش',
            'برف': 'برف',
            'موسم': 'موسم',
            'گرمی': 'گرمی',
            'سردی': 'سردی',
            'خوشی': 'خوشی',
            'غم': 'غم',
            'خوف': 'خوف',
            'امید': 'امید',
            'محبت': 'محبت',
            'نفرت': 'نفرت',
            'غصہ': 'غصہ',
            'حیرت': 'حیرت',
            'فکر': 'فکر',
            'پریشانی': 'پریشانی',
            'آرام': 'آرام',
            'راحت': 'راحت',
            'تکلیف': 'تکلیف',
            'درد': 'درد',
            'بیماری': 'بیماری',
            'صحت': 'صحت',
            'طاقت': 'طاقت',
            'کمزوری': 'کمزوری',
            'زندگی': 'زندگی',
            'موت': 'موت',
            'پیدائش': 'پیدائش',
            'مرنا': 'مرنا',
            'جینا': 'جینا',
            'رونا': 'رونا',
            'ہنسنا': 'ہنسنا',
            'کھیلنا': 'کھیلنا',
            'کھانا': 'کھانا',
            'پینا': 'پینا',
            'سونا': 'سونا',
            'بیٹھنا': 'بیٹھنا',
            'کھڑا': 'کھڑا',
            'چلنا': 'چلنا',
            'دوڑنا': 'دوڑنا',
            'اڑنا': 'اڑنا',
            'گرنا': 'گرنا',
            'اٹھنا': 'اٹھنا'
        }
        
        # Load custom dictionary if available
        self.load_custom_dictionary()
    
    def load_custom_dictionary(self, file_path="urdu_dictionary.json"):
        """Load custom dictionary from JSON file"""
        try:
            if os.path.exists(file_path):
                with open(file_path, 'r', encoding='utf-8') as f:
                    custom_dict = json.load(f)
                    if isinstance(custom_dict, dict):
                        self.common_corrections.update(custom_dict)
                    elif isinstance(custom_dict, list):
                        self.urdu_dictionary.update(custom_dict)
        except Exception as e:
            print(f"Could not load custom dictionary: {e}")
    
    def save_custom_dictionary(self, file_path="urdu_dictionary.json"):
        """Save dictionary to JSON file"""
        try:
            with open(file_path, 'w', encoding='utf-8') as f:
                json.dump(self.common_corrections, f, ensure_ascii=False, indent=2)
        except Exception as e:
            print(f"Could not save dictionary: {e}")
    
    def similarity(self, a, b):
        """Calculate similarity between two strings"""
        return SequenceMatcher(None, a, b).ratio()
    
    def get_suggestions(self, word, max_suggestions=3):
        """Get spelling suggestions for a word"""
        suggestions = []
        
        # Check if word is already correct
        if word in self.urdu_dictionary:
            return [word]
        
        # Check common corrections first
        if word in self.common_corrections:
            return [self.common_corrections[word]]
        
        # Find similar words in dictionary
        for correct_word in self.urdu_dictionary:
            similarity_score = self.similarity(word, correct_word)
            if similarity_score > 0.6:  # Threshold for similarity
                suggestions.append((correct_word, similarity_score))
        
        # Sort by similarity and return top suggestions
        suggestions.sort(key=lambda x: x[1], reverse=True)
        return [word for word, score in suggestions[:max_suggestions]]
    
    def correct_word(self, word):
        """Correct a single word"""
        # Check exact match in corrections
        if word in self.common_corrections:
            return self.common_corrections[word]
        
        # Check if word is already correct
        if word in self.urdu_dictionary:
            return word
        
        # Get best suggestion
        suggestions = self.get_suggestions(word)
        if suggestions:
            return suggestions[0]
        
        return word  # Return original if no suggestions
    
    def spell_check_text(self, text, auto_correct=True):
        """Spell check entire text"""
        words = text.split()
        corrected_words = []
        corrections_made = []
        
        for word in words:
            # Clean word of punctuation for checking
            clean_word = re.sub(r'[^\w\u0600-\u06FF]', '', word)
            
            if clean_word:
                corrected_word = self.correct_word(clean_word)
                
                if corrected_word != clean_word:
                    corrections_made.append({
                        'original': clean_word,
                        'corrected': corrected_word,
                        'suggestions': self.get_suggestions(clean_word)
                    })
                    
                    if auto_correct:
                        # Replace the clean word in original word (preserve punctuation)
                        final_word = word.replace(clean_word, corrected_word)
                        corrected_words.append(final_word)
                    else:
                        corrected_words.append(word)
                else:
                    corrected_words.append(word)
            else:
                corrected_words.append(word)
        
        return {
            'corrected_text': ' '.join(corrected_words),
            'corrections': corrections_made,
            'original_text': text
        }
    
    def add_word_to_dictionary(self, word):
        """Add a word to the dictionary"""
        self.urdu_dictionary.add(word)
    
    def add_correction(self, wrong_word, correct_word):
        """Add a correction to the corrections dictionary"""
        self.common_corrections[wrong_word] = correct_word
